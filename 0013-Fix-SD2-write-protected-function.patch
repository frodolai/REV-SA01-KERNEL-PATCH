From 84617e47934ed306e03ef04a5682ed3dd49a1fc5 Mon Sep 17 00:00:00 2001
From: Nick Liu <nick_liu@avalue.com.tw>
Date: Tue, 3 Jan 2017 17:48:11 +0800
Subject: [PATCH] Fix SD2 write protected function.

modified:   kernel/arch/arm/boot/dts/imx6qdl-smarc-pfuze100.dtsi
modified:   kernel/arch/arm/boot/dts/imx6qdl-smarc-wm8326.dtsi
---
 .../arch/arm/boot/dts/imx6qdl-smarc-pfuze100.dtsi  | 33 +++++++++------
 kernel/arch/arm/boot/dts/imx6qdl-smarc-wm8326.dtsi | 49 ++++++++++++----------
 2 files changed, 48 insertions(+), 34 deletions(-)

diff --git a/kernel/arch/arm/boot/dts/imx6qdl-smarc-pfuze100.dtsi b/kernel/arch/arm/boot/dts/imx6qdl-smarc-pfuze100.dtsi
index 052de4e..cc3bf46 100644
--- a/kernel/arch/arm/boot/dts/imx6qdl-smarc-pfuze100.dtsi
+++ b/kernel/arch/arm/boot/dts/imx6qdl-smarc-pfuze100.dtsi
@@ -101,7 +101,13 @@
         reg_lvds_bkl_en: lvds_bkl_en {
             compatible = "regulator-fixed";
             regulator-name = "lvds_bkl_en";
-            gpio = <&gpio3 00 GPIO_ACTIVE_HIGH>;
+            gpio = <&gpio3 0 GPIO_ACTIVE_HIGH>;
+        };
+
+        reg_sd2_pwr_en: sd2_pwr_en {
+            compatible = "regulator-fixed";
+            regulator-name = "sd2_pwr_en";
+            gpio = <&gpio1 25 GPIO_ACTIVE_HIGH>;
         };
     };
 
@@ -639,27 +645,28 @@
                 MX6QDL_PAD_SD2_DAT3__SD2_DATA3      0x17059
                 MX6QDL_PAD_EIM_DA14__GPIO3_IO14     0x80000000
                 MX6QDL_PAD_EIM_DA13__GPIO3_IO13     0x80000000
+                MX6QDL_PAD_ENET_CRS_DV__GPIO1_IO25  0x80000000
             >;
         };
 
         pinctrl_usdhc4: usdhc4grp {
             fsl,pins = <
-                MX6QDL_PAD_SD4_CMD__SD4_CMD        0x17059
-                MX6QDL_PAD_SD4_CLK__SD4_CLK        0x10059
-                MX6QDL_PAD_SD4_DAT0__SD4_DATA0        0x17059
-                MX6QDL_PAD_SD4_DAT1__SD4_DATA1        0x17059
-                MX6QDL_PAD_SD4_DAT2__SD4_DATA2        0x17059
-                MX6QDL_PAD_SD4_DAT3__SD4_DATA3        0x17059
-                MX6QDL_PAD_SD4_DAT4__SD4_DATA4        0x17059
-                MX6QDL_PAD_SD4_DAT5__SD4_DATA5        0x17059
-                MX6QDL_PAD_SD4_DAT6__SD4_DATA6        0x17059
-                MX6QDL_PAD_SD4_DAT7__SD4_DATA7        0x17059
+                MX6QDL_PAD_SD4_CMD__SD4_CMD         0x17059
+                MX6QDL_PAD_SD4_CLK__SD4_CLK         0x10059
+                MX6QDL_PAD_SD4_DAT0__SD4_DATA0      0x17059
+                MX6QDL_PAD_SD4_DAT1__SD4_DATA1      0x17059
+                MX6QDL_PAD_SD4_DAT2__SD4_DATA2      0x17059
+                MX6QDL_PAD_SD4_DAT3__SD4_DATA3      0x17059
+                MX6QDL_PAD_SD4_DAT4__SD4_DATA4      0x17059
+                MX6QDL_PAD_SD4_DAT5__SD4_DATA5      0x17059
+                MX6QDL_PAD_SD4_DAT6__SD4_DATA6      0x17059
+                MX6QDL_PAD_SD4_DAT7__SD4_DATA7      0x17059
             >;
         };
 
         pinctrl_wdog: wdoggrp {
             fsl,pins = <
-                MX6QDL_PAD_GPIO_1__WDOG2_B 0x80000000
+                MX6QDL_PAD_GPIO_1__WDOG2_B          0x80000000
             >;
         };
     };
@@ -806,7 +813,7 @@
     pinctrl-0 = <&pinctrl_usdhc2>;
     bus-width = <4>;
     cd-gpios = <&gpio3 14 GPIO_ACTIVE_LOW>;
-    wp-gpios = <&gpio3 13 GPIO_ACTIVE_LOW>;
+    wp-gpios = <&gpio3 13 GPIO_ACTIVE_HIGH>;
     no-1-8-v;
     keep-power-in-suspend;
     enable-sdio-wakeup;
diff --git a/kernel/arch/arm/boot/dts/imx6qdl-smarc-wm8326.dtsi b/kernel/arch/arm/boot/dts/imx6qdl-smarc-wm8326.dtsi
index 3389edd..cd4d275 100644
--- a/kernel/arch/arm/boot/dts/imx6qdl-smarc-wm8326.dtsi
+++ b/kernel/arch/arm/boot/dts/imx6qdl-smarc-wm8326.dtsi
@@ -99,7 +99,13 @@
         reg_lvds_bkl_en: lvds_bkl_en {
             compatible = "regulator-fixed";
             regulator-name = "lvds_bkl_en";
-            gpio = <&gpio3 00 GPIO_ACTIVE_HIGH>;
+            gpio = <&gpio3 0 GPIO_ACTIVE_HIGH>;
+        };
+
+        reg_sd2_pwr_en: sd2_pwr_en {
+            compatible = "regulator-fixed";
+            regulator-name = "sd2_pwr_en";
+            gpio = <&gpio1 25 GPIO_ACTIVE_HIGH>;
         };
     };
 
@@ -523,35 +529,36 @@
 
         pinctrl_usdhc2: usdhc2grp {
             fsl,pins = <
-                MX6QDL_PAD_SD2_CMD__SD2_CMD        0x17059
-                MX6QDL_PAD_SD2_CLK__SD2_CLK        0x10059
-                MX6QDL_PAD_SD2_DAT0__SD2_DATA0        0x17059
-                MX6QDL_PAD_SD2_DAT1__SD2_DATA1        0x17059
-                MX6QDL_PAD_SD2_DAT2__SD2_DATA2        0x17059
-                MX6QDL_PAD_SD2_DAT3__SD2_DATA3        0x17059
-                MX6QDL_PAD_EIM_DA14__GPIO3_IO14        0x80000000
-                MX6QDL_PAD_EIM_DA13__GPIO3_IO13        0x80000000
+                MX6QDL_PAD_SD2_CMD__SD2_CMD         0x17059
+                MX6QDL_PAD_SD2_CLK__SD2_CLK         0x10059
+                MX6QDL_PAD_SD2_DAT0__SD2_DATA0      0x17059
+                MX6QDL_PAD_SD2_DAT1__SD2_DATA1      0x17059
+                MX6QDL_PAD_SD2_DAT2__SD2_DATA2      0x17059
+                MX6QDL_PAD_SD2_DAT3__SD2_DATA3      0x17059
+                MX6QDL_PAD_EIM_DA14__GPIO3_IO14     0x80000000
+                MX6QDL_PAD_EIM_DA13__GPIO3_IO13     0x80000000
+                MX6QDL_PAD_ENET_CRS_DV__GPIO1_IO25  0x80000000
             >;
         };
 
         pinctrl_usdhc4: usdhc4grp {
             fsl,pins = <
-                MX6QDL_PAD_SD4_CMD__SD4_CMD        0x17059
-                MX6QDL_PAD_SD4_CLK__SD4_CLK        0x10059
-                MX6QDL_PAD_SD4_DAT0__SD4_DATA0        0x17059
-                MX6QDL_PAD_SD4_DAT1__SD4_DATA1        0x17059
-                MX6QDL_PAD_SD4_DAT2__SD4_DATA2        0x17059
-                MX6QDL_PAD_SD4_DAT3__SD4_DATA3        0x17059
-                MX6QDL_PAD_SD4_DAT4__SD4_DATA4        0x17059
-                MX6QDL_PAD_SD4_DAT5__SD4_DATA5        0x17059
-                MX6QDL_PAD_SD4_DAT6__SD4_DATA6        0x17059
-                MX6QDL_PAD_SD4_DAT7__SD4_DATA7        0x17059
+                MX6QDL_PAD_SD4_CMD__SD4_CMD         0x17059
+                MX6QDL_PAD_SD4_CLK__SD4_CLK         0x10059
+                MX6QDL_PAD_SD4_DAT0__SD4_DATA0      0x17059
+                MX6QDL_PAD_SD4_DAT1__SD4_DATA1      0x17059
+                MX6QDL_PAD_SD4_DAT2__SD4_DATA2      0x17059
+                MX6QDL_PAD_SD4_DAT3__SD4_DATA3      0x17059
+                MX6QDL_PAD_SD4_DAT4__SD4_DATA4      0x17059
+                MX6QDL_PAD_SD4_DAT5__SD4_DATA5      0x17059
+                MX6QDL_PAD_SD4_DAT6__SD4_DATA6      0x17059
+                MX6QDL_PAD_SD4_DAT7__SD4_DATA7      0x17059
             >;
         };
 
         pinctrl_wdog: wdoggrp {
             fsl,pins = <
-                MX6QDL_PAD_GPIO_1__WDOG2_B 0x80000000
+                MX6QDL_PAD_GPIO_1__WDOG2_B          0x80000000
             >;
         };
     };
@@ -698,7 +705,7 @@
     pinctrl-0 = <&pinctrl_usdhc2>;
     bus-width = <4>;
     cd-gpios = <&gpio3 14 GPIO_ACTIVE_LOW>;
-    wp-gpios = <&gpio3 13 GPIO_ACTIVE_LOW>;
+    wp-gpios = <&gpio3 13 GPIO_ACTIVE_HIGH>;
     no-1-8-v;
     keep-power-in-suspend;
     enable-sdio-wakeup;
-- 
1.9.1

